---
name: "test_cloud"

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
  pull_request:
    branches: main
  schedule:
    - cron: '0 2 * * *'  # Nightly run at 2:00 AM UTC

jobs:
  cloud_smt_tests:
    name: ClickHouse Cloud SharedMergeTree Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      PYTHONPATH: dbt
      DBT_CH_TEST_HOST: ${{ secrets.DBT_TESTS_CLOUD_HOST_SMT }}
      DBT_CH_TEST_PASSWORD: ${{ secrets.DBT_TESTS_CLOUD_PASSWORD_SMT }}
      DBT_CH_TEST_CLUSTER_MODE: true
      DBT_CH_TEST_CLOUD: true

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install requirements
        run: pip3 install . -r dev_requirements.txt

      - name: Run HTTP tests
        env:
          DBT_CH_TEST_PORT: 8443
        run: pytest tests --timeout=240

      - name: Run Native tests
        env:
          DBT_CH_TEST_PORT: 9440
        run: pytest tests --timeout=240
