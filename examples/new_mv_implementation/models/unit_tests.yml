version: 2

unit_tests:
  - name: test_streaming_events_mv_mobile_filters_only_mobile_events
    description: "Verify that only events with event_type starting with 'mobile.' are included"
    model: new_mv_mv2
    given:
      - input: ref('events')
        rows:
          # Mobile events (should be included)
          - { event_id: 1, event_time: "2024-01-15 10:00:00", event_type: "mobile.click", user_id: 101, value: 1.5 }
          - { event_id: 2, event_time: "2024-01-15 10:05:00", event_type: "mobile.app_open", user_id: 102, value: 2.0 }
          - { event_id: 3, event_time: "2024-01-15 11:00:00", event_type: "mobile.purchase", user_id: 103, value: 50.0 }
          # Non-mobile events (should be filtered out)
          - { event_id: 4, event_time: "2024-01-15 10:30:00", event_type: "page_view", user_id: 104, value: 1.0 }
          - { event_id: 5, event_time: "2024-01-15 10:45:00", event_type: "click", user_id: 105, value: 3.0 }
          - { event_id: 6, event_time: "2024-01-15 12:00:00", event_type: "purchase", user_id: 106, value: 100.0 }
      # Mock events_aggregated (not used in SELECT, but needed for dependency resolution)
      - input: ref('new_mv_target_model')
        rows: []
    expect:
      rows:
        # Only mobile events, aggregated by date and type
        - { event_date: "2024-01-15", event_type: "mobile.click", event_count: 1, total_value: 1.5 }
        - { event_date: "2024-01-15", event_type: "mobile.app_open", event_count: 1, total_value: 2.0 }
        - { event_date: "2024-01-15", event_type: "mobile.purchase", event_count: 1, total_value: 50.0 }

  - name: test_streaming_events_mv_mobile_aggregates_same_type_same_day
    description: "Verify that multiple events of same type on same day are aggregated"
    model: new_mv_mv2
    given:
      - input: ref('events')
        rows:
          # Multiple mobile.click events on same day
          - { event_id: 1, event_time: "2024-01-15 10:00:00", event_type: "mobile.click", user_id: 101, value: 1.0 }
          - { event_id: 2, event_time: "2024-01-15 11:00:00", event_type: "mobile.click", user_id: 102, value: 2.0 }
          - { event_id: 3, event_time: "2024-01-15 12:00:00", event_type: "mobile.click", user_id: 103, value: 3.0 }
          # Different day
          - { event_id: 4, event_time: "2024-01-16 10:00:00", event_type: "mobile.click", user_id: 104, value: 5.0 }
      # Mock events_aggregated (not used in SELECT, but needed for dependency resolution)
      - input: ref('new_mv_target_model')
        rows: []
    expect:
      rows:
        - { event_date: "2024-01-15", event_type: "mobile.click", event_count: 3, total_value: 6.0 }
        - { event_date: "2024-01-16", event_type: "mobile.click", event_count: 1, total_value: 5.0 }

  # ============================================================
  # Tests for user_activity_mv (standard multi-MV materialized_view)
  # This model has TWO MVs: mobile and web, combined with UNION ALL
  # ============================================================

  - name: test_user_activity_mv_separates_mobile_and_web
    description: "Verify mobile and web events are aggregated separately per user"
    model: old_mv_model
    given:
      - input: ref('events')
        rows:
          # User 101: 2 mobile events, 1 web event
          - { event_id: 1, event_time: "2024-01-15 10:00:00", event_type: "mobile.click", user_id: 101, value: 1.0 }
          - { event_id: 2, event_time: "2024-01-15 10:05:00", event_type: "mobile.purchase", user_id: 101, value: 50.0 }
          - { event_id: 3, event_time: "2024-01-15 10:10:00", event_type: "page_view", user_id: 101, value: 2.0 }
          # User 102: only web events
          - { event_id: 4, event_time: "2024-01-15 11:00:00", event_type: "click", user_id: 102, value: 3.0 }
          - { event_id: 5, event_time: "2024-01-15 11:05:00", event_type: "page_view", user_id: 102, value: 1.0 }
    expect:
      rows:
        # User 101 appears twice: once from mobile MV, once from web MV
        - { user_id: 101, total_events: 2, total_value: 51.0, unique_event_types: 2 }  # mobile
        - { user_id: 101, total_events: 1, total_value: 2.0, unique_event_types: 1 }   # web
        - { user_id: 102, total_events: 2, total_value: 4.0, unique_event_types: 2 }   # web only

  - name: test_user_activity_mv_mobile_only_user
    description: "Verify user with only mobile events appears once"
    model: old_mv_model
    given:
      - input: ref('events')
        rows:
          # User 101: only mobile events
          - { event_id: 1, event_time: "2024-01-15 10:00:00", event_type: "mobile.click", user_id: 101, value: 1.0 }
          - { event_id: 2, event_time: "2024-01-15 10:05:00", event_type: "mobile.app_open", user_id: 101, value: 2.0 }
          - { event_id: 3, event_time: "2024-01-15 10:10:00", event_type: "mobile.click", user_id: 101, value: 3.0 }
    expect:
      rows:
        # Only one row from mobile MV (2 unique types: mobile.click and mobile.app_open)
        - { user_id: 101, total_events: 3, total_value: 6.0, unique_event_types: 2 }

